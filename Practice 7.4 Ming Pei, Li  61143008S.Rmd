---
title: "Practice 7.4 HW"
author: "Ming Pei Li"
date: "2024-11-17"
output: html_document
---

```{r, warning = FALSE, message = FALSE}
library (tidyverse)
```

```{r}
rairuoho <- read.table ('Data/rairuoho.txt', header = TRUE)
```


```{r}
pearson.test <- function (x, y, conf.level = 0.95, alternative = c("two.sided", "less", "greater")) {
  # è¨­å®šæ›¿ä»£å‡è¨­æ–¹å‘
  alternative <- match.arg (alternative) # å‡½æ•¸çš„åƒæ•¸å€¼æ˜¯å¦ç¬¦åˆé æœŸçš„é¸é …ä¹‹ä¸€ã€‚å¦‚æœåƒæ•¸å€¼èˆ‡é¸é …ä¸åŒ¹é…ï¼Œmatch.arg() æœƒè‡ªå‹•å ±éŒ¯ã€‚
  
  # è¨­å®šè³‡æ–™åç¨±
  DNAME <- paste (deparse1 (substitute (x)), "and", deparse1 (substitute (y)))
  
  # substitute() å‡½æ•¸æœƒè¿”å›å‚³å…¥è®Šæ•¸ï¼ˆx å’Œ yï¼‰çš„è¡¨é”å¼ï¼Œå³è®Šæ•¸æœ¬èº«ï¼Œè€Œä¸æ˜¯è®Šæ•¸çš„å€¼ã€‚æ›å¥è©±èªªï¼Œå®ƒæœƒå°‡è®Šæ•¸åç¨±ä½œç‚ºä¸€å€‹ç¬¦è™Ÿï¼ˆsymbolï¼‰è¿”å›ã€‚
  # ä¾‹å¦‚ï¼Œå¦‚æœ x æ˜¯ day3ï¼Œsubstitute(x) æœƒè¿”å› day3 é€™å€‹ç¬¦è™Ÿï¼Œè€Œä¸æ˜¯å®ƒçš„å€¼ã€‚
  # deparse1() å‡½æ•¸æœƒå°‡ç¬¦è™Ÿï¼ˆå¦‚ day3ï¼‰è½‰æ›ç‚ºå­—ä¸² "day3"ã€‚é€™æ˜¯å°‡ substitute(x) æˆ– substitute(y) è½‰æ›ç‚ºå­—ç¬¦ä¸²çš„æ­¥é©Ÿã€‚
  # paste() å‡½æ•¸æœƒå°‡å¤šå€‹å…ƒç´ ï¼ˆé€™è£¡æ˜¯è®Šæ•¸åç¨±å’Œ "and" å­—ä¸²ï¼‰åˆä½µæˆä¸€å€‹å–®ä¸€çš„å­—ä¸²ã€‚é€™è£¡å°‡ x å’Œ y çš„è®Šæ•¸åç¨±ï¼ˆå¦‚ day3 å’Œ day4ï¼‰ä»¥ "and" é€£æ¥ã€‚
  
  # è³‡æ–™æª¢æŸ¥
  if (!is.numeric (x)) stop ("'x' must be a numeric vector")
  if (!is.numeric (y)) stop ("'y' must be a numeric vector")
  if (length (x) != length (y)) stop ("'x' and 'y' must have the same length")
  
  # å»é™¤ç¼ºå¤±å€¼
  x <- x[complete.cases (x, y)]
  y <- y[complete.cases (x, y)]
  n <- length (x)
  # complete.cases  æª¢æ¸¬æ˜¯å¦æœ‰NA
  
  # æ ·æœ¬æ•¸æª¢æŸ¥
  if (n < 3L) stop ("Sample size must be at least 3 to calculate Pearson correlation")
  
  # è¨ˆç®—çš®çˆ¾æ£®ç›¸é—œä¿‚æ•¸å’Œçµ±è¨ˆé‡
  method <- "Pearson's correlation"
  r <- cor (x, y)
  df <- n - 2
  statistic <-  r * sqrt (df) / sqrt (1 - r^2)
  
  # è¨ˆç®— p å€¼
  p.value <- switch(
    alternative,
    less = pt (statistic, df),
    greater = pt (statistic, df, lower.tail = FALSE),
    two.sided = 2 * min (pt(statistic, df), pt (statistic, df, lower.tail = FALSE))
  )
  
  # è¨ˆç®—ä¿¡è³´å€é–“
  z <- atanh (r)
  sigma <- 1 / sqrt (n - 3)
  critical <- qnorm ((1 + conf.level) / 2)
  conf.int <- tanh (z + c(-1, 1) * sigma * critical)
  attr (conf.int, "conf.level") <- conf.level
  
  # qnorm(p) æ˜¯å°‡ç´¯ç©æ©Ÿç‡ğ‘ï¼Œè¨ˆç®—å›æ­£æ…‹åˆ†ä½ˆä¸­å°æ‡‰çš„è‡¨ç•Œå€¼ï¼ˆå³æ©«åº§æ¨™å€¼ï¼‰ã€‚ä¾‹å¦‚ï¼Œqnorm(0.975) çš„çµæœå¤§ç´„æ˜¯ 1.96ï¼Œè¡¨ç¤ºæ­£æ…‹åˆ†ä½ˆä¸­ç´¯ç©æ©Ÿç‡ç‚º 97.5% æ™‚çš„æ©«åº§æ¨™å€¼ã€‚
  # c(-1, 1) è¡¨ç¤ºä¿¡è³´å€é–“çš„ä¸Šä¸‹å…©å€‹ç•Œé™ï¼Œå°æ–¼ä¸‹ç•Œä½¿ç”¨ -1ï¼Œå°æ–¼ä¸Šç•Œä½¿ç”¨ +1ã€‚
  # tanh(z...)å°‡è¨ˆç®—å‡ºçš„ z è»¸çš„ç•Œé™è½‰æ›å›ç›¸é—œä¿‚æ•¸ r çš„ç¯„åœã€‚
  #attr() ç”¨æ–¼å„²å­˜æˆ–æª¢ç´¢ R ç‰©ä»¶çš„é™„åŠ è³‡è¨Šã€‚åœ¨é€™å€‹ä¾‹å­ä¸­ï¼Œattr(conf.int, "conf.level") <- conf.level å°‡ä¿¡è³´æ°´æº–å„²å­˜åœ¨ conf.int ç‰©ä»¶ä¸­ã€‚
  
  # è¿”å›çµæœ
  result <- list(
    statistic = c(t = statistic),
    parameter = c(df = df, n = n),
    p.value = p.value,
    estimate = c(correlation = r),
    conf.int = conf.int,
    null.value = 0,
    alternative = alternative,
    method = method,
    data.name = DNAME
  )
  class (result) <- "htest"
  return (result)}

# é€™è¡Œç¨‹å¼ç¢¼å°‡ result çš„é¡åˆ¥ï¼ˆclassï¼‰è¨­ç½®ç‚º "htest"ï¼Œä½¿å…¶ç¬¦åˆ R çš„çµ±è¨ˆæª¢å®šçµæœæ ¼å¼ã€‚
# æ¨™æº–åŒ–çµæœï¼š
# åœ¨ R ä¸­ï¼Œè¨±å¤šçµ±è¨ˆæª¢å®šï¼ˆå¦‚ t.test() æˆ– cor.test()ï¼‰éƒ½è¿”å›é¡åˆ¥ç‚º "htest" çš„ç‰©ä»¶ã€‚é€šéè¨­å®šé€™å€‹é¡åˆ¥ï¼Œresult å¯ä»¥èˆ‡å…¶ä»–çµ±è¨ˆæª¢å®šçµæœä¿æŒä¸€è‡´ã€‚
# æ–¹ä¾¿è¼¸å‡ºï¼š
# R çš„å…§å»ºå‡½æ•¸æœƒæ ¹æ“šç‰©ä»¶çš„é¡åˆ¥ï¼Œä½¿ç”¨é©ç•¶çš„æ ¼å¼è¼¸å‡ºçµæœã€‚å°æ–¼ "htest" é¡å‹çš„ç‰©ä»¶ï¼ŒR æœƒè‡ªå‹•ä»¥ä¸€ç¨®ç°¡æ½”ã€å¯è®€çš„æ ¼å¼é¡¯ç¤ºæª¢å®šçµæœã€‚
```

The correlation test for the nutrient group
```{r}
day3_4_nu <- rairuoho %>% filter (treatment == "nutrient") %>% with (pearson.test (day3, day4))
day3_4_nu
day3_8_nu <- rairuoho %>% filter (treatment == "nutrient") %>% with (pearson.test (day3, day8))
day3_8_nu
```

The correlation test for the water group
```{r}
day3_4_wa <- rairuoho %>% filter (treatment == "water") %>% with (pearson.test (day3, day4))
day3_4_wa
day3_8_wa <- rairuoho %>% filter (treatment == "water") %>% with (pearson.test (day3, day8))
day3_8_wa
```

åœ¨ R ä¸­ï¼Œwith() å‡½æ•¸è¢«ç”¨ä¾†ç°¡åŒ–å° data.frame ä¸­æ¬„ä½çš„å¼•ç”¨ã€‚ç•¶æˆ‘å€‘ä½¿ç”¨ with(data, expression) æ™‚ï¼Œdata çš„æ¬„ä½å¯ä»¥åœ¨ expression ä¸­ç›´æ¥å¼•ç”¨ï¼Œè€Œä¸éœ€è¦ç”¨ $ã€‚åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œwith() æœƒå°‡ç¯©é¸å¾Œçš„ data.frame ä½œç‚ºä¸€å€‹ç’°å¢ƒä¾†è§£æ day3 å’Œ day4 ç­‰è®Šé‡åç¨±ï¼Œä½¿å¾—å®ƒå€‘å¯ä»¥åœ¨ cor.test() ä¸­ç›´æ¥è¢«å¼•ç”¨ã€‚
